<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cupra Tavascan - Asistente Digital</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="signup" class="tab-content active">
        <div class="signup-container">
            <h1>Bienvenido al <strong class="copper-text">CUPRA TAVASCAN</strong></h1>
            <p>Regístrate para descubrir todo sobre tu vehículo.</p>
            <form id="signup-form">
                <div class="form-group">
                    <label for="license-plate">Número de matrícula:</label>
                    <input type="text" id="license-plate" placeholder="Introduce tu matrícula" required>
                </div>
                <div class="form-group">
                    <label for="car-model">Modelo de SEAT:</label>
                    <select id="car-model" required>
                        <option value="" disabled selected>Selecciona tu modelo</option>
                        <option value="CUPRA TAVASCAN">CUPRA TAVASCAN</option>
                        <option value="SEAT LEON">SEAT LEON</option>
                        <option value="SEAT IBIZA">SEAT IBIZA</option>
                        <option value="SEAT ARONA">SEAT ARONA</option>
                    </select>
                </div>
                <button type="submit" class="action-btn">Registrarse</button>
            </form>
            <p id="error-message" style="color: red; display: none;">Este modelo no es compatible con esta aplicación.</p>
        </div>
    </div>
    <video id="background-video" autoplay muted loop>
        <source src="{{ url_for('static', filename='videos/Back.mp4') }}" type="video/mp4">
    </video>
    <header>
        <img src="{{ url_for('static', filename='images/logos/cupra-logo.png') }}" alt="CUPRA Logo" class="logo">
    </header>

    <nav id="menu">
        <ul>
            <li><a href="#home" class="menu-link active">Inicio</a></li>
            <li><a href="#simulator" class="menu-link">Simulador 3D</a></li>
            <li><a href="#signup" class="menu-link">Registro</a></li>
        </ul>
    </nav>

    <main>
        <div class="two-column-layout">
            <!-- Columna izquierda - Chat -->
            <div class="left-column">
                <div id="chat-container">
                    <div class="chat-header">
                        <h2>CUPRA Asistente Virtual</h2>
                    </div>
                    <div class="chat-messages" id="chat-messages">
                        <div class="message bot">
                            <div class="message-content">
                                <p>¡Hola! Soy tu asistente virtual de CUPRA. ¿En qué puedo ayudarte hoy?</p>
                            </div>
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" id="chat-input" placeholder="Escribe tu mensaje aquí...">
                        <button id="chat-submit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Columna derecha - Contenido principal -->
            <div class="right-column">
                <div class="container">
                    <div id="home" class="tab-content active">
                        <h1>Asistente Digital <strong class="copper-text">CUPRA TAVASCAN</strong></h1>

                        <div class="instructions">
                            <p>Descubre todo sobre tu Cupra Tavascan de manera interactiva:</p>
                            <ol>
                                <li>Sube una imagen de tu vehículo o de los controles</li>
                            </ol>
                        </div>

                        <div class="upload-container">
                            <input type="file" id="file-input" accept="image/*" style="display: none;">
                            <button class="upload-btn" id="browse-btn">Subir imagen</button>
                        </div>

                        <div id="image-workspace">
                            <div class="image-container">
                                <img id="uploaded-image" src="" alt="Imagen subida">
                                <div class="selection-overlay" id="selection-overlay"></div>
                                <div class="selection-box" id="selection-box"></div>
                            </div>

                            <div class="action-buttons">
                                <button class="action-btn" id="reset-btn">Reiniciar selección</button>
                                <button class="action-btn" id="submit-btn">Consultar</button>
                            </div>

                            <div class="loading" id="loading">
                                <div class="spinner"></div>
                                <p>Analizando imagen...</p>
                            </div>

                            <div class="explanation-container" id="explanation-container">
                                <h2 class="explanation-title">Información detallada</h2>
                                <div class="selected-area">
                                    <img id="cropped-image" class="selected-image" src="" alt="Área seleccionada">
                                    <div class="explanation-content" id="explanation-content">
                                        La información sobre esta parte del Cupra Tavascan aparecerá aquí.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="simulator" class="tab-content">
                        <h1>Simulador 3D</h1>
                        <div id="image-viewer">
                            <button id="prev-btn" class="arrow-btn">⟵</button>
                            <div id="image-container">
                                <img id="simulator-image" src="cupra_frames/1.png" alt="3D Simulation">
                                <div class="selection-overlay" id="simulator-selection-overlay"></div>
                                <div class="selection-box" id="simulator-selection-box"></div>
                            </div>
                            <button id="next-btn" class="arrow-btn">⟶</button>
                        </div>
                        <div id="zoom-controls">
                            <button id="zoom-in-btn" class="zoom-btn">Zoom In</button>
                            <button id="zoom-out-btn" class="zoom-btn">Zoom Out</button>
                        </div>
                        <div class="action-buttons">
                            <button class="action-btn" id="simulator-reset-btn">Reiniciar selección</button>
                            <button class="action-btn" id="simulator-submit-btn">Consultar</button>
                        </div>
                        <div class="loading" id="simulator-loading">
                            <div class="spinner"></div>
                            <p>Analizando imagen...</p>
                        </div>
                        <div class="explanation-container" id="simulator-explanation-container">
                            <h2 class="explanation-title">Información detallada</h2>
                            <div class="selected-area">
                                <img id="simulator-cropped-image" class="selected-image" src="" alt="Área seleccionada">
                                <div class="explanation-content" id="simulator-explanation-content">
                                    La información sobre esta parte del simulador aparecerá aquí.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        © 2025 CUPRA. Todos los derechos reservados.
    </footer>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
        async function sendChatMessage(message) {
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: message })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();

                if (data.error) {
                    console.error('Error from server:', data.error);
                    return {
                        answer: "Lo siento, no puedo responder en este momento. Por favor, inténtalo de nuevo.",
                        page_numbers: [],
                        figure_numbers: []
                    };
                }

                return data;
            } catch (error) {
                console.error('Error sending chat message:', error);
                return {
                    answer: "Lo siento, ha ocurrido un error al procesar tu consulta. Por favor, inténtalo de nuevo.",
                    page_numbers: [],
                    figure_numbers: []
                };
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chat-input');
            const chatSubmit = document.getElementById('chat-submit');
            const chatMessages = document.getElementById('chat-messages');

            // Función para añadir mensajes al chat
            function addMessage(message, isUser) {
                const messageDiv = document.createElement('div');
                messageDiv.className = isUser ? 'message user' : 'message bot';

                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';

                const paragraph = document.createElement('p');
                paragraph.textContent = message;

                contentDiv.appendChild(paragraph);
                messageDiv.appendChild(contentDiv);
                chatMessages.appendChild(messageDiv);

                // Scroll al fondo
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Manejar el envío de mensajes
            async function handleSubmit() {
                const message = chatInput.value.trim();
                if (!message) return;

                // Agregar mensaje del usuario
                addMessage(message, true);
                chatInput.value = '';

                // Mostrar indicador de carga
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'message bot loading';
                loadingDiv.innerHTML = '<div class="message-content"><p>Escribiendo...</p></div>';
                chatMessages.appendChild(loadingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Obtener respuesta
                const response = await sendChatMessage(message);

                // Quitar indicador de carga
                chatMessages.removeChild(loadingDiv);

                // Mostrar respuesta
                addMessage(response.answer, false);
            }

            // Event listeners
            chatSubmit.addEventListener('click', handleSubmit);
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleSubmit();
                }
            });
        });
    </script>
</body>
</html>